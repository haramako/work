// DON'T TOUCH. THIS FILE IS AUTO GENERATED BY codegen.rb
using System;
using System.Collections.Generic;
using System.Linq;

using ToydeaCabinet;
using ToydeaCabinet.Indexer;

<%- if prog.namespace %>
namespace <%=prog.namespace%> {
<%- end -%>

public static class Keys
{
    <%- keys.each do |idx,name| -%>
    public const byte <%=name%> = <%=idx%>;
    <%- end -%>
}

<%- prog.tables.each do |t| -%>
public partial class <%=t.name%>
{
    CabinetKeyBuilder kb = new CabinetKeyBuilder();
    Cabinet c;

    public <%=t.name%>(Cabinet _c)
    {
        c = _c;
    }

    public <%=t.cls%> Find(<%=param_args(t.key,1,false)%>)
    {
        var key = kb.Cleared().Store(Keys.<%=t.name%>).Store(<%=t.key[0][1]%>).Build();
        var data = c.Get(key);
        if (data.IsEmpty)
        {
            return null;
        }
        else
        {
            return <%=t.cls%>.Deserialize(data);
        }
    }

    public void Save(<%=t.cls%> v)
    {
        var key = kb.Cleared().Store(Keys.<%=t.name%>).Store(v.<%=t.key[0][1]%>).Build();
        c.Put(key, v.Serialize());
        <%- t.decls.each do |decl| -%>
        c.Put(<%=param_make_key_save(t, decl, prefix: 'v.')%>, new ByteSpan());
        <%- end -%>
    }

    <%- t.decls.each do |decl| -%>
    <%- (1..decl.params.size).each do |len| -%>
    public IEnumerable<<%=t.cls%>> SearchBy<%=param_funcname(decl.params)%>(<%= param_args(decl.params,len)%>)
    {
        var start = <%=param_make_key(t, decl, len, 'Start')%>;
        var end = <%=param_make_key(t, decl, len, 'End')%>;
        var found = c.GetRange(start, end);
        byte[] buf = new byte[16];
        return found.Select(kv =>
        {
            kv.Key.WriteTo(buf, 0);
            var id = MyBitConverter.Reverse(BitConverter.ToInt32(buf, 9));
            return Find(id);
        });
    }
    <%- end -%>
    <%- end -%>
}
<%- end -%>

<%- if prog.namespace %>
}
<%- end -%>
