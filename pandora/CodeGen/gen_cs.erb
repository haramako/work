// DON'T TOUCH. THIS FILE IS AUTO GENERATED BY codegen.rb
using System;
using System.Collections.Generic;
using System.Linq;

using ToydeaCabinet;
using ToydeaCabinet.Indexer;

<%- if ast.namespace %>
namespace <%=ast.namespace%> {
<%- end -%>

public static class Keys
{
    <%- ast.keys.each do |key| -%>
    public const byte <%=key.keyname%> = <%=key.idx%>;
    <%- end -%>
}

<%- ast.tables.each do |t| -%>
public partial class <%=t.name%>
{
    CabinetKeyBuilder kb = new CabinetKeyBuilder();
    Cabinet c;

    public <%=t.name%>(Cabinet _c)
    {
        c = _c;
    }

    public <%=t.cls.name%> Find(<%=t.key.func_args(is_range: false)%>)
    {
        var key = <%=t.key.make_get_key%>;
        var data = c.Get(key);
        if (data.IsEmpty)
        {
            return null;
        }
        else
        {
            return <%=t.cls.name%>.Deserialize(data);
        }
    }

    public void Save(<%=t.cls.name%> v)
    {
        c.Put(<%=t.key.make_put_key('v.')%>, v.Serialize());
        <%- t.indices.each do |index| -%>
        c.Put(<%=index.key.make_put_key('v.')%>, new ByteSpan());
        <%- end -%>
    }

    <%- t.indices.each do |index| -%>
    <%- (1..index.key.fields.size).each do |len| -%>
    public IEnumerable<<%=t.cls.name%>> SearchBy<%=index.key.funcname%>(<%= index.key.func_args(len)%>)
    {
        var start = <%=index.key.make_get_key(len, 'Start')%>;
        var end = <%=index.key.make_get_key(len, 'End')%>;
        var found = c.GetRange(start, end);
        byte[] buf = new byte[4];
        return found.Select(kv =>
        {
            kv.Key.WriteTo(buf, 0, <%=index.key.index_size%>);
            var id = MyBitConverter.Reverse(BitConverter.ToInt32(buf));
            return Find(id);
        });
    }

    <%- end -%>
    <%- end -%>
}
<%- end -%>

<%- if ast.namespace %>
}
<%- end -%>
