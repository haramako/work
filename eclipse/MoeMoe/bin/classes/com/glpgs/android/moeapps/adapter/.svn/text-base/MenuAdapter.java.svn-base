package com.glpgs.android.moeapps.adapter;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import android.content.Context;
import android.content.res.Resources;
import android.support.v4.app.Fragment;
import android.support.v4.app.FragmentTransaction;
import android.util.Log;
import android.view.View;
import android.webkit.WebSettings;
import android.widget.AdapterView;
import android.widget.AdapterView.OnItemClickListener;
import android.widget.SimpleAdapter;

import com.glpgs.android.moeapps.MoeMoeActivity;
import com.glpgs.android.moeapps.R;
import com.glpgs.android.moeapps.config.EnvironmentProvider;
import com.glpgs.android.moeapps.flagment.SettingFragment;
import com.glpgs.android.moeapps.util.MoeMoeUtil;

public class MenuAdapter implements OnItemClickListener {
	private static final boolean LOG = EnvironmentProvider.LOG;
	private static final String TAG = "MenuAdapter";

	private static final String WEBPATH = EnvironmentProvider.getWebBase();
	private static final String PATH_MOPURITAN = EnvironmentProvider.MENU_MOPURITAN;
	private static final String PATH_MYMOE_APP = EnvironmentProvider.MENU_MYMOE_APP;

	private List<Map<String, Object>> listData = new ArrayList<Map<String, Object>>();
	private SimpleAdapter menuAdp;

	private MoeMoeActivity moeActivity;
	private Resources res = null;

	private FragmentTransaction fragmentTransaction = null;
	private SettingFragment stgFragment = null;
	private Fragment lastFlagment;

	//現在選択されているメニューの番号
	public int prev_pos = 0;

	public MenuAdapter(MoeMoeActivity activity, Resources resources) {
		if(moeActivity != null) {
			return;
		}
		moeActivity = activity;
		res = resources;
	}

	public SimpleAdapter init(Context context) {
		if (menuAdp != null) {
			return menuAdp;
		}

		listData.add(getMapData(R.drawable.menu_icon_new, "新着萌えアプリ"));
		listData.add(getMapData(R.drawable.menu_icon_rank, "ランキング"));
		listData.add(getMapData(R.drawable.menu_icon_moe, "もプリたんについて"));
		listData.add(getMapData(R.drawable.menu_icon_heart, "マイ萌えアプリ"));
		listData.add(getMapData(R.drawable.menu_icon_stg, "その他"));

		menuAdp = new SimpleAdapter(context, listData, R.layout.menu_cell,
				new String[] {
					item.icon.name,
					item.title.name },
				new int[] {
					item.icon.id,
					item.title.id
				});

		fragmentTransaction = moeActivity.getSupportFragmentManager().beginTransaction();
		stgFragment = new SettingFragment();
		return menuAdp;
	}

	@Override
	public void onItemClick(AdapterView<?> adapterView, View view, int position, long arg3) {
		if(LOG) Log.d(TAG, TAG + ".onItemClick start! position : " + position);

		if(MoeMoeActivity.slideMenu.getStarted()) {
			//メニューの開閉中のときは処理しない
			return;
		}

		if (prev_pos != position || position == 3) {
			MoeMoeActivity.titleName = (String) MoeMoeActivity.titleNameView.getText();
			prev_pos = position;

			if (position == 0 && !moeActivity.latestViewPageSwitch) {
				if(LOG) Log.d(TAG, "新着アプリキターーーー");
				MoeMoeActivity.titleNameView.setText(res.getString(R.string.pname_latest_moe));
				moeActivity.changePageView();
			} else if (position == 1 && moeActivity.latestViewPageSwitch) {
				if(LOG) Log.d(TAG, "ランキングキターーーー");
				MoeMoeActivity.titleNameView.setText(res.getString(R.string.pname_ranking));
				moeActivity.changePageView();
			} else if (position == 2) {
				if(LOG) Log.d(TAG, "もプリたんについてキターーーー");
				MoeMoeActivity.singleWebView.loadUrl(WEBPATH + PATH_MOPURITAN);
			} else if (position == 3) {
				if(LOG) Log.d(TAG, "マイ萌えアプリキターーーー");
				MoeMoeActivity.singleWebView.getSettings().setCacheMode(WebSettings.LOAD_DEFAULT);
				MoeMoeActivity.singleWebView.loadUrl(WEBPATH + PATH_MYMOE_APP);
				MoeMoeActivity.singleWebView.getSettings().setCacheMode(WebSettings.LOAD_CACHE_ELSE_NETWORK);
			} else if (position == 4) {
				if(LOG) Log.d(TAG, "その他キターーーー");
				if (LOG) Log.d(TAG, "lastFlagment : " + lastFlagment);
				if(lastFlagment != stgFragment) {
					fragmentTransaction.add(R.id.setting_view, stgFragment);
					lastFlagment = stgFragment;
					fragmentTransaction.commit();
				}
			}
		}

		if(position == 0 || position == 1) {
			MoeMoeActivity.timelineTitleName = (String) MoeMoeActivity.titleNameView.getText();
			MoeMoeUtil.setInvisible(MoeMoeActivity.singleWebView);
			MoeMoeUtil.setInvisible(MoeMoeActivity.settingView);
		} else if(position == 2 || position == 3) {
			if(position == 2) {
				MoeMoeActivity.titleNameView.setText(res.getString(R.string.pname_moplitan));
			} else if(position == 3) {
				MoeMoeActivity.titleNameView.setText(res.getString(R.string.pname_mymoeapp));
			}
			MoeMoeUtil.setVisible(MoeMoeActivity.singleWebView);
			MoeMoeUtil.setVisible(MoeMoeActivity.backButton);
			MoeMoeUtil.setInvisible(MoeMoeActivity.menuButton);
		} else if(position == 4) {
			MoeMoeActivity.titleNameView.setText(res.getString(R.string.pname_other));
			MoeMoeUtil.setVisible(MoeMoeActivity.settingView);
			MoeMoeUtil.setVisible(MoeMoeActivity.backButton);
			MoeMoeUtil.setInvisible(MoeMoeActivity.singleWebView);
			MoeMoeUtil.setInvisible(MoeMoeActivity.menuButton);
		}

		//メニュー開閉イベントを呼ぶ
		MoeMoeActivity.slideMenu.callIvent();
	}

	private Map<String, Object> getMapData(int menuIcon, String menuName) {
		Map<String, Object> map = new HashMap<String, Object>();
		map.put(item.icon.name, menuIcon);
		map.put(item.title.name, menuName);

		return map;
	}

	private enum item {
		icon("menu_image", R.id.menu_icon), title("menu_name", R.id.menu_name);

		private final String name;
		private final int id;

		item(String item_name, int item_id) {
			this.name = item_name;
			this.id = item_id;
		}
	}
}
