package com.glpgs.android.moeapps.view;

import static com.glpgs.android.moeapps.config.EnvironmentProvider.CACHE_PATH;

import java.util.List;

import org.apache.http.cookie.Cookie;

import android.annotation.SuppressLint;
import android.content.Context;
import android.content.Intent;
import android.graphics.Bitmap;
import android.graphics.Color;
import android.net.Uri;
import android.util.AttributeSet;
import android.util.Log;
import android.view.GestureDetector;
import android.view.GestureDetector.OnDoubleTapListener;
import android.view.GestureDetector.OnGestureListener;
import android.view.MotionEvent;
import android.view.View;
import android.webkit.CookieManager;
import android.webkit.CookieSyncManager;
import android.webkit.WebSettings;
import android.webkit.WebView;
import android.webkit.WebViewClient;
import android.widget.FrameLayout;
import android.widget.LinearLayout;

import com.glpgs.android.moeapps.MoeMoeActivity;
import com.glpgs.android.moeapps.R;
import com.glpgs.android.moeapps.ScreenshotActivity;
import com.glpgs.android.moeapps.config.EnvironmentProvider;
import com.glpgs.android.moeapps.http.MoeMoeHttpClientManager;
import com.glpgs.android.moeapps.util.MoeMoeUtil;

@SuppressLint("SetJavaScriptEnabled")
public class MoeMoeWebView extends WebView /*implements OnGestureListener, OnDoubleTapListener*/ {
    private static final boolean LOG = EnvironmentProvider.LOG;
	private static final String TAG = "MoeMoeWebView";

	private static final String WEBPATH = EnvironmentProvider.getWebBase();

	private Context context = getContext();

	//WebViewの上下のフェードのサイズ
	private static final int FADINGLENGTH = 15;

	GestureDetector gestureDetector;
	//リロードかどうか
	public boolean checkReload = false;

	public MoeMoeWebView(Context context, AttributeSet attrs) {
		super(context, attrs);
		if(LOG) Log.d(TAG, TAG + " start!!");

		//gestureDetector = new GestureDetector(getContext(), this);

		//JavaScreiptを有効にする
		getSettings().setJavaScriptEnabled(true);
		//キャッシュに存在する場合はそちらを使用。cacheに無い or expireした場合はネットワーク経由でデータを取得
		getSettings().setCacheMode(WebSettings.LOAD_NORMAL);
		//getSettings().setCacheMode(WebSettings.LOAD_NO_CACHE);
		getSettings().setAppCacheMaxSize(1 * 1024 * 1024);
		getSettings().setAppCachePath(CACHE_PATH);
		getSettings().setUseWideViewPort(true);
		getSettings().setLoadWithOverviewMode(true);
		//ウェブサイトをアプリ内で表示
		setWebViewClient(new MoeMoeWebViewClient());
		//スクロールバー部分の隙間を消す
		setVerticalScrollbarOverlay(true);
		//スクロールバー領域をブラウザ領域の内側に表示させる
		setScrollBarStyle(View.SCROLLBARS_INSIDE_OVERLAY);
		//タップしたときにフォーカスをあてる
		requestFocus(View.FOCUS_DOWN);
		setVerticalFadingEdgeEnabled(true);
		//上限のフェードの幅
		setFadingEdgeLength(MoeMoeUtil.getDpiPixcelSize(FADINGLENGTH));

		CookieSyncManager.createInstance(getContext());
		CookieSyncManager.getInstance().startSync();
		CookieManager.getInstance().setAcceptCookie(true);
		CookieManager.getInstance().removeExpiredCookie();
	}

	@Override
	public void reload() {
		checkReload = true;
		super.reload();
	}

	/*
	 * @see android.view.View#getSolidColor()
	 * WebViewの上下にグラデーションを表示
	 */
	@Override
	public int getSolidColor() {
		return Color.argb(255, 255, 255, 255);
	}

//	@Override
//	public boolean dispatchTouchEvent(MotionEvent e) {
//		super.dispatchTouchEvent(e);
//		gestureDetector.onTouchEvent(e);
//		//return onTouchEvent(e);
//		return true;
//	}
//
//	/* (非 Javadoc)
//	 * @see android.view.GestureDetector.OnDoubleTapListener#onDoubleTap(android.view.MotionEvent)
//	 * ダブルタップによる拡大縮小を無効にする
//	 */
//	@Override
//	public boolean onDoubleTap(MotionEvent e) {
//		if(LOG) Log.d(TAG, "TouchEvent onDoubleTap");
//		return true;
//	}
//
//	@Override
//	public boolean onDoubleTapEvent(MotionEvent e) {
//		if(LOG) Log.d(TAG, "TouchEvent onDoubleTapEvent");
//		return false;
//	}
//
//	@Override
//	public boolean onSingleTapConfirmed(MotionEvent e) {return false;}
//	@Override
//	public boolean onDown(MotionEvent e) {return false;}
//	@Override
//	public boolean onFling(MotionEvent e1, MotionEvent e2, float velocityX, float velocityY) {return false;}
//	@Override
//	public void onLongPress(MotionEvent e) {}
//	@Override
//	public boolean onScroll(MotionEvent e1, MotionEvent e2, float distanceX, float distanceY) {return false;}
//	@Override
//	public void onShowPress(MotionEvent e) {}
//	@Override
//	public boolean onSingleTapUp(MotionEvent e) {return false;}

	/**
	 * WebViewClientをカスタムしてWebViewの操作に必要な機能を実装する
	 */
	private class MoeMoeWebViewClient extends WebViewClient {
	    private static final boolean LOG = EnvironmentProvider.LOG;
		private static final String TAG = "MoeMoeWebViewClient";

		private static final String PATH_APPINFO = EnvironmentProvider.MOE_APPINFO_KEYWORD;
		private static final String PATH_MOPURITAN = EnvironmentProvider.MENU_MOPURITAN;
		private static final String PATH_MYMOE_APP = EnvironmentProvider.MENU_MYMOE_APP;
		private static final String PATH_FAQ = EnvironmentProvider.MENU_FAQ;
		private static final String PATH_NOTICE = EnvironmentProvider.MENU_NOTICE;

		private static final String PATH_MARKET = EnvironmentProvider.MOE_APP_MARKET;
		private static final String PATH_SCREENSHOT = EnvironmentProvider.MOE_APP_SCREENSHOT;
		private static final String PATH_DOWNLOAD = EnvironmentProvider.MOE_APP_DOWNLOAD;

		@Override
		public boolean shouldOverrideUrlLoading(WebView view, String url) {
			if(LOG) Log.d(TAG, "shouldOverrideUrlLoading() \nURL : " + url);

			if(!view.getUrl().equals(url)) {
				//ネットワークの状態を調べる
				if(MoeMoeUtil.checkNetwork()) {
					if(url.indexOf(WEBPATH + PATH_SCREENSHOT) != -1) {
						if(LOG) Log.d(TAG, "Displays Screenshot.");
						final Intent intent = new Intent(getContext(), ScreenshotActivity.class);
						intent.putExtra("screenshot", url);
						getContext().startActivity(intent);
					} else if(url.indexOf(WEBPATH + PATH_DOWNLOAD) != -1) {
						if(LOG) Log.d(TAG, "リダイレクト");
						//リダイレクト
						return super.shouldOverrideUrlLoading(view, url);
					} else if(url.indexOf(PATH_MARKET) != -1) {
						if(LOG) Log.d(TAG, "リダイレクト２ google store");
						Intent intent = new Intent(Intent.ACTION_VIEW);
						intent.setData(Uri.parse(url));
						context.startActivity(intent);
						return true;
					} else if(url.indexOf(WEBPATH+PATH_APPINFO) != -1) {
						if(LOG) Log.d(TAG, "アプリ情報");
						//アプリ情報のURLの場合
						MoeMoeUtil.setVisible(MoeMoeActivity.backButton);
						MoeMoeUtil.setInvisible(MoeMoeActivity.menuButton);
						MoeMoeUtil.isMymoeApp = true;
						MoeMoeUtil.setInvisible(view);
						MoeMoeActivity.appinfoWebView.clearView();
						MoeMoeActivity.appinfoWebView.loadUrl(url);
						MoeMoeUtil.setVisible(MoeMoeActivity.appinfoWebView);
						MoeMoeActivity.titleName = (String) MoeMoeActivity.titleNameView.getText();
						MoeMoeActivity.titleNameView.setText(getResources().getString(R.string.pname_app_info));
					} else {
						if(LOG) Log.d(TAG, "非表示");
						MoeMoeUtil.setInvisible(view);
					}
				} else {
					MoeMoeUtil.showToast(getResources().getString(R.string.error_toast_network));
				}
			}
			return true;
		}

		@Override
		public void onPageStarted(WebView view, String url, Bitmap favicon) {
			if(LOG) Log.d(TAG, "onPageStarted() 読み込みはじめたよ～ \nURL : " + url);
			if(url.indexOf(WEBPATH + PATH_DOWNLOAD) != -1 || url.indexOf(PATH_MARKET) != -1 || url.indexOf(WEBPATH+PATH_APPINFO) != -1) {
				return;
			}
			view.clearView();
		}

		@Override
		public void onPageFinished(WebView view, String url) {
			if(LOG) Log.d(TAG, "onPageFinished() 読み込みおわったよ～ \nURL : " + url);

			if(url.indexOf(WEBPATH + PATH_DOWNLOAD) != -1 || url.indexOf(PATH_MARKET) != -1 || url.indexOf(WEBPATH+PATH_APPINFO) != -1) {
				return;
			}

			//ネットワークの状態を調べる
			if(MoeMoeUtil.checkNetwork()) {
				LinearLayout connectErrorView = (LinearLayout) ((FrameLayout) view.getParent()).findViewById(R.id.network_error_view);
				if(connectErrorView.getVisibility() == 0 && checkReload) {
					checkReload = false;
					MoeMoeUtil.setInvisible(connectErrorView);
				}
			}

			if(MoeMoeHttpClientManager.getCookieStore() != null) {
				Cookie cookie = null;
				if (MoeMoeHttpClientManager.getCookieStore() != null ) {
					List<Cookie> cookies = MoeMoeHttpClientManager.getCookieStore().getCookies();
					if (!cookies.isEmpty()) {
						for (int i = 0; i < cookies.size(); i++) {
							cookie = cookies.get(i);
						}
					}
					if (cookie != null) {
						String cookieString = cookie.getName() + "=" + cookie.getValue() + "; domain=" + cookie.getDomain();
						//CookieManager.getInstance().setCookie(url, CookieManager.getInstance().getCookie(url));
						CookieManager.getInstance().setCookie(EnvironmentProvider.getWebBase(), cookieString);
						//Log.d(TAG, "cookieString : " + cookieString);
						CookieSyncManager.getInstance().sync();
					}
				}
			}

			titleChange(url);
			MoeMoeUtil.setInvisible(MoeMoeActivity.menuButton);
			MoeMoeUtil.setVisible(MoeMoeActivity.backButton);
			MoeMoeUtil.setVisible(view);
		}

		@Override
		public void onReceivedError(WebView view, int errorCode, String description, String failingUrl) {
			if(LOG) Log.e(TAG, "onReceivedError errorCode : " + errorCode);
			LinearLayout connectErrorView = (LinearLayout) ((FrameLayout) view.getParent()).findViewById(R.id.network_error_view);
			MoeMoeUtil.setVisible(connectErrorView);
			checkReload = false;
		}

		@Override
		public void doUpdateVisitedHistory(WebView view, String url, boolean isReload) {
			super.doUpdateVisitedHistory(view, url, isReload);
			//if(LOG) Log.d(TAG, "doUpdateVisitedHistory : " + url);
		}

		/**
		 * 表示しているURLに応じて画面タイトルを変更する
		 * @param url 現在表示しているURL
		 */
		private void titleChange(String url) {
			//もプリたんとかマイ萌えアプリページとか
			if(url.indexOf(WEBPATH+PATH_MOPURITAN) != -1) {
				MoeMoeActivity.titleNameView.setText(getResources().getString(R.string.pname_moplitan));
			} else if(url.indexOf(WEBPATH+PATH_MYMOE_APP) != -1) {
				MoeMoeActivity.titleNameView.setText(getResources().getString(R.string.pname_mymoeapp));
			} else if(url.indexOf(WEBPATH+PATH_FAQ) != -1) {
				MoeMoeActivity.titleNameView.setText(getResources().getString(R.string.pname_faq));
			} else if(url.indexOf(WEBPATH+PATH_NOTICE) != -1) {
				MoeMoeActivity.titleNameView.setText(getResources().getString(R.string.pname_notice));
			}
		}
	}
}
